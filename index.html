<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kotogram - Безопасный мессенджер</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module">
        // Импорт Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { 
            getFirestore,
            collection,
            addDoc,
            getDocs,
            getDoc,
            setDoc,
            doc,
            updateDoc,
            query,
            where,
            onSnapshot,
            orderBy,
            serverTimestamp,
            increment,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCcaRsyPSMvuNrHPEqEwg_kajoLhlvsv2M",
            authDomain: "kotogram-c360f.firebaseapp.com",
            projectId: "kotogram-c360f",
            storageBucket: "kotogram-c360f.firebasestorage.app",
            messagingSenderId: "239052405176",
            appId: "1:239052405176:web:13edcac46bcda62606774d",
            measurementId: "G-7D107G76RD"
        };

        // Инициализация Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Экспорт для использования в основном скрипте
        window.firebase = {
            auth,
            db,
            storage,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            collection,
            addDoc,
            getDocs,
            getDoc,
            setDoc,
            doc,
            updateDoc,
            query,
            where,
            onSnapshot,
            orderBy,
            serverTimestamp,
            ref,
            uploadBytes,
            getDownloadURL,
            increment,
            runTransaction
        };

        console.log("Firebase инициализирован!");
    </script>
    <style>
        /* Общие стили */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .hidden {
            display: none !important;
        }

        /* Экраны приложения */
        .app-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.3s;
        }

        /* Экран загрузки */
        .loading-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            z-index: 1000;
        }

        .loading-logo {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Экран авторизации */
        .auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            position: relative;
            z-index: 100;
        }

        .app-logo {
            color: #0088cc;
            font-size: 42px;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #666;
            transition: all 0.3s;
        }

        .auth-tab.active {
            color: #0088cc;
            border-bottom: 3px solid #0088cc;
            margin-bottom: -2px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-input {
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: #0088cc;
        }

        .auth-button {
            background: #0088cc;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }

        .auth-button:hover {
            background: #0077b3;
        }

        .secondary-button {
            background: #f5f5f5;
            color: #333;
        }

        .secondary-button:hover {
            background: #e5e5e5;
        }

        .form-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .error-message {
            color: #ff4444;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Основной интерфейс */
        .main-screen {
            display: flex;
            height: 100vh;
            background: #f0f2f5;
        }

        /* Боковая панель */
        .sidebar {
            width: 360px;
            background: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e1e8ed;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }

        .sidebar-header {
            padding: 20px;
            background: #0088cc;
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
        }

        .user-info {
            flex: 1;
        }

        .user-info h3 {
            margin: 0;
            font-size: 18px;
        }

        .user-info p {
            margin: 3px 0 0;
            font-size: 13px;
            opacity: 0.9;
        }

        .search-container {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e1e8ed;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 20px;
            padding: 10px 15px;
        }

        .search-box i {
            color: #999;
            margin-right: 10px;
        }

        .search-input {
            flex: 1;
            border: none;
            background: none;
            outline: none;
            font-size: 14px;
        }

        /* Список чатов */
        .chats-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-item:hover {
            background: #f9f9f9;
        }

        .chat-item.active {
            background: #e8f4fc;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
            font-size: 18px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .chat-name {
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }

        .chat-time {
            font-size: 12px;
            color: #999;
        }

        .chat-preview {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            background: #0088cc;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .no-chats {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .no-chats i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        /* Область чата */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #e5ddd5 url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAI0lEQVQokWP8////fwY0wMTExMBADMAVMFI0YIClAgAACQkDAf2TUIgAAAAASUVORK5CYII=');
            position: relative;
        }

        .chat-header {
            background: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e1e8ed;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            z-index: 5;
        }

        .contact-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .contact-details {
            flex: 1;
            min-width: 0;
        }

        .contact-details h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-details p {
            margin: 3px 0 0;
            font-size: 13px;
            color: #0088cc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-actions {
            display: flex;
            gap: 20px;
            flex-shrink: 0;
        }

        .chat-action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 18px;
            transition: color 0.2s;
            flex-shrink: 0;
        }

        .chat-action-btn:hover {
            color: #0088cc;
        }

        /* Контейнер сообщений */
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: transparent;
        }

        .message-date {
            text-align: center;
            margin: 20px 0;
            color: #666;
            font-size: 13px;
            position: relative;
        }

        .message-date:before {
            content: '';
            position: absolute;
            left: 20px;
            right: 20px;
            top: 50%;
            height: 1px;
            background: #ddd;
            z-index: 1;
        }

        .message-date span {
            background: #f0f0f0;
            padding: 5px 15px;
            border-radius: 15px;
            position: relative;
            z-index: 2;
        }

        /* Стили сообщений */
        .message {
            max-width: 70%;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.outgoing {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            background-size: cover;
            background-position: center;
        }

        .message-content {
            background: white;
            padding: 12px 15px;
            border-radius: 18px;
            border-top-left-radius: 4px;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            max-width: 100%;
            word-break: break-word;
        }

        .message.outgoing .message-content {
            background: #dcf8c6;
            border-top-right-radius: 4px;
            border-top-left-radius: 18px;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
            text-align: right;
            white-space: nowrap;
        }

        .message.outgoing .message-time {
            color: #4caf50;
        }

        .no-chat-selected {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            text-align: center;
            padding: 40px;
        }

        .no-chat-selected i {
            font-size: 64px;
            margin-bottom: 20px;
            color: #ccc;
        }

        /* Панель ввода сообщения */
        .message-input-area {
            background: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-top: 1px solid #e1e8ed;
            box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.05);
        }

        .input-actions {
            display: flex;
            gap: 15px;
            flex-shrink: 0;
        }

        .input-action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 20px;
            transition: color 0.2s;
            flex-shrink: 0;
        }

        .input-action-btn:hover {
            color: #0088cc;
        }

        .message-input {
            flex: 1;
            border: none;
            background: #f5f5f5;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 15px;
            outline: none;
            resize: none;
            max-height: 120px;
            min-height: 45px;
            line-height: 1.4;
            font-family: inherit;
        }

        .send-button {
            background: #0088cc;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .send-button:hover {
            background: #0077b3;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Правая панель (информация о чате) */
        .info-panel {
            width: 350px;
            background: white;
            border-left: 1px solid #e1e8ed;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
            position: relative;
            z-index: 20;
        }

        .info-panel.hidden {
            transform: translateX(100%);
        }

        .info-header {
            padding: 20px;
            background: #0088cc;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .close-info-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }

        .info-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .contact-media {
            text-align: center;
            margin-bottom: 30px;
        }

        .media-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: bold;
            background-size: cover;
            background-position: center;
        }

        .media-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .media-status {
            color: #0088cc;
            font-size: 14px;
        }

        .info-section {
            margin-bottom: 25px;
        }

        .info-section h4 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
        }

        .info-label {
            color: #666;
            flex-shrink: 0;
        }

        .info-value {
            font-weight: 500;
            text-align: right;
            word-break: break-word;
            flex: 1;
            margin-left: 10px;
        }

        /* Модальные окна */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            padding: 20px;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            transform: translateY(20px);
            transition: transform 0.3s;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1001;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            background: #0088cc;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            padding: 25px;
            max-height: calc(90vh - 70px);
            overflow-y: auto;
        }

        .modal-input-group {
            margin-bottom: 20px;
        }

        .modal-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .modal-input:focus {
            outline: none;
            border-color: #0088cc;
        }

        .modal-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            font-weight: bold;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .avatar-preview:hover::after {
            content: 'Изменить';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .avatar-input {
            display: none;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .modal-primary {
            background: #0088cc;
            color: white;
        }

        .modal-primary:hover {
            background: #0077b3;
        }

        .modal-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .modal-secondary:hover {
            background: #e5e5e5;
        }

        .modal-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Уведомления */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1100;
            opacity: 0;
            transition: all 0.3s;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background: #4caf50;
        }

        .toast.error {
            background: #ff4444;
        }

        .toast.info {
            background: #2196f3;
        }

        /* Меню */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 900;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .menu-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .side-menu {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 300px;
            background: white;
            transform: translateX(-100%);
            transition: transform 0.3s;
            z-index: 1000;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
        }

        .side-menu.active {
            transform: translateX(0);
        }

        .menu-header {
            padding: 30px 20px;
            background: #0088cc;
            color: white;
        }

        .menu-items {
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: #333;
            text-decoration: none;
            transition: background 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 16px;
        }

        .menu-item:hover {
            background: #f5f5f5;
        }

        .menu-item i {
            margin-right: 15px;
            font-size: 18px;
            width: 24px;
            text-align: center;
            color: #666;
        }

        /* Поиск пользователей в модальном окне */
        .user-search-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-search-item:hover {
            background: #f9f9f9;
        }

        .user-search-item:last-child {
            border-bottom: none;
        }

        .user-search-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-right: 12px;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .user-search-info {
            flex: 1;
            min-width: 0;
        }

        .user-search-name {
            font-weight: 600;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-search-username {
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-loading {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        .search-loading .loader {
            margin-bottom: 10px;
        }

        .no-search-results {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        /* Адаптивность */
        @media (max-width: 1200px) {
            .sidebar {
                width: 300px;
            }
            .info-panel {
                width: 300px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
            }
            .info-panel {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                z-index: 100;
            }
            .message {
                max-width: 85%;
            }
            .modal {
                max-width: 95%;
            }
        }

        /* Эмодзи палитра */
        .emoji-picker {
            position: absolute;
            bottom: 80px;
            right: 20px;
            width: 300px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            padding: 15px;
            z-index: 100;
            display: none;
        }

        .emoji-picker.show {
            display: block;
            animation: fadeIn 0.2s;
        }

        .emoji-category {
            margin-bottom: 15px;
        }

        .emoji-category h4 {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .emoji {
            font-size: 20px;
            text-align: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.2s;
        }

        .emoji:hover {
            background: #f0f0f0;
        }

        /* Индикатор загрузки */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0088cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        /* Биография в информации */
        .info-bio {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
            color: #555;
        }

        /* Скроллбар */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <!-- Экран загрузки -->
    <div id="loadingScreen" class="app-screen loading-screen">
        <div class="loading-logo">K</div>
        <h2>Kotogram</h2>
        <p>Безопасный и быстрый мессенджер</p>
        <div class="loading-spinner"></div>
    </div>

    <!-- Экран авторизации -->
    <div id="authScreen" class="app-screen auth-screen hidden">
        <div class="auth-container">
            <div class="app-logo">Kotogram</div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Вход</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Регистрация</button>
            </div>
            
            <div id="loginForm" class="form-section">
                <input type="text" id="loginEmail" class="auth-input" placeholder="Email" required>
                <div id="loginEmailError" class="error-message"></div>
                
                <input type="password" id="loginPassword" class="auth-input" placeholder="Пароль" required>
                <div id="loginPasswordError" class="error-message"></div>
                
                <button onclick="login()" class="auth-button" id="loginButton">Войти</button>
            </div>
            
            <div id="registerForm" class="form-section hidden">
                <input type="text" id="regUsername" class="auth-input" placeholder="Имя пользователя" required>
                <div id="regUsernameError" class="error-message"></div>
                
                <input type="email" id="regEmail" class="auth-input" placeholder="Email" required>
                <div id="regEmailError" class="error-message"></div>
                
                <input type="password" id="regPassword" class="auth-input" placeholder="Пароль (минимум 6 символов)" required>
                <div id="regPasswordError" class="error-message"></div>
                
                <input type="password" id="regConfirmPassword" class="auth-input" placeholder="Подтвердите пароль" required>
                <div id="regConfirmPasswordError" class="error-message"></div>
                
                <button onclick="register()" class="auth-button" id="registerButton">Зарегистрироваться</button>
            </div>
        </div>
    </div>

    <!-- Основной интерфейс -->
    <div id="mainScreen" class="app-screen main-screen hidden">
        <!-- Боковая панель -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-avatar" id="currentUserAvatar" onclick="openMenu()">К</div>
                <div class="user-info">
                    <h3 id="currentUserName">Загрузка...</h3>
                    <p id="currentUserStatus">в сети</p>
                </div>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" class="search-input" placeholder="Поиск пользователей по никнейму" 
                           id="searchInput" oninput="searchUsers()">
                </div>
            </div>
            
            <div class="chats-list" id="chatsList">
                <div class="no-chats">
                    <i class="fas fa-comments"></i>
                    <h3>Нет чатов</h3>
                    <p>Начните общение, найдя пользователей через поиск</p>
                </div>
            </div>
        </div>
        
        <!-- Область чата -->
        <div class="chat-area">
            <div class="chat-header hidden" id="chatHeader">
                <div class="contact-info">
                    <div class="contact-avatar" id="currentChatAvatar">А</div>
                    <div class="contact-details">
                        <h3 id="currentChatName">Выберите чат</h3>
                        <p id="currentChatStatus">онлайн</p>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn" onclick="toggleChatSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="chat-action-btn" onclick="toggleInfoPanel()">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div class="no-chat-selected" id="noChatSelected">
                    <i class="fas fa-comment-dots"></i>
                    <h2>Выберите чат</h2>
                    <p>Начните общение с другим пользователем</p>
                </div>
            </div>
            
            <div class="message-input-area hidden" id="messageInputArea">
                <div class="input-actions">
                    <button class="input-action-btn" onclick="attachFile()">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="input-action-btn" onclick="toggleEmojiPicker()">
                        <i class="far fa-smile"></i>
                    </button>
                </div>
                <textarea class="message-input" id="messageInput" 
                          placeholder="Введите сообщение..." 
                          rows="1"
                          oninput="autoResizeTextarea(this)"
                          onkeydown="handleMessageKeydown(event)"></textarea>
                <button class="send-button" onclick="sendMessage()" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <!-- Панель информации -->
        <div class="info-panel hidden" id="infoPanel">
            <div class="info-header">
                <h3>Информация о пользователе</h3>
                <button class="close-info-btn" onclick="toggleInfoPanel()">×</button>
            </div>
            <div class="info-content">
                <div class="contact-media">
                    <div class="media-avatar" id="infoAvatar">А</div>
                    <div class="media-name" id="infoName">Загрузка...</div>
                    <div class="media-status" id="infoStatus">был(а) недавно</div>
                </div>
                
                <div class="info-section">
                    <h4>Общая информация</h4>
                    <div class="info-item">
                        <span class="info-label">Никнейм</span>
                        <span class="info-value" id="infoUsername">@user</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Имя</span>
                        <span class="info-value" id="infoDisplayName">Пользователь</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">В Kotogram с</span>
                        <span class="info-value" id="infoJoinDate">2024</span>
                    </div>
                </div>
                
                <div class="info-section" id="bioSection">
                    <h4>О себе</h4>
                    <div class="info-bio" id="infoBio">
                        Нет информации
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Меню -->
    <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <div class="user-avatar" id="menuUserAvatar">К</div>
            <h3 id="menuUserName">Загрузка...</h3>
            <p id="menuUserEmail">user@example.com</p>
        </div>
        <div class="menu-items">
            <div class="menu-item" onclick="showProfileSettings()">
                <i class="fas fa-user-edit"></i>
                <span>Редактировать профиль</span>
            </div>
            <div class="menu-item" onclick="showNewChatModal()">
                <i class="fas fa-comment-medical"></i>
                <span>Новый чат</span>
            </div>
            <div class="menu-item" onclick="showContacts()">
                <i class="fas fa-users"></i>
                <span>Контакты</span>
            </div>
            <div class="menu-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Выйти</span>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div class="modal-overlay" id="modalOverlay"></div>
    
    <!-- Модальное окно редактирования профиля -->
    <div class="modal hidden" id="profileModal">
        <div class="modal-header">
            <h3>Редактирование профиля</h3>
            <button class="modal-close" onclick="closeModal()">×</button>
        </div>
        <div class="modal-content">
            <div class="avatar-upload">
                <div class="avatar-preview" id="avatarPreview" onclick="triggerAvatarUpload()">
                    К
                </div>
                <input type="file" id="avatarInput" class="avatar-input" accept="image/*" onchange="handleAvatarUpload(event)">
                <p style="color: #666; font-size: 14px;">Нажмите на аватар для загрузки</p>
            </div>
            
            <div class="modal-input-group">
                <label class="modal-label">Никнейм* (уникальный)</label>
                <input type="text" class="modal-input" id="profileUsername" placeholder="username" required>
                <div id="profileUsernameError" class="error-message"></div>
            </div>
            
            <div class="modal-input-group">
                <label class="modal-label">Отображаемое имя</label>
                <input type="text" class="modal-input" id="profileDisplayName" placeholder="Имя Фамилия">
            </div>
            
            <div class="modal-input-group">
                <label class="modal-label">О себе</label>
                <textarea class="modal-input modal-textarea" id="profileBio" placeholder="Расскажите о себе..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="modal-button modal-secondary" onclick="closeModal()">Отмена</button>
                <button class="modal-button modal-primary" onclick="updateProfile()" id="updateProfileButton">
                    Сохранить
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно нового чата -->
    <div class="modal hidden" id="newChatModal">
        <div class="modal-header">
            <h3>Поиск пользователей</h3>
            <button class="modal-close" onclick="closeModal()">×</button>
        </div>
        <div class="modal-content">
            <div class="modal-input-group">
                <input type="text" class="modal-input" id="userSearchInput" 
                       placeholder="Введите никнейм или имя пользователя" 
                       oninput="searchUsersForChat()"
                       autocomplete="off">
            </div>
            <div id="searchResults" style="max-height: 300px; overflow-y: auto;">
                <div class="no-search-results">
                    <i class="fas fa-search" style="font-size: 32px; margin-bottom: 10px; color: #ccc;"></i>
                    <p>Начните вводить никнейм для поиска</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Эмодзи палитра -->
    <div class="emoji-picker" id="emojiPicker">
        <div class="emoji-category">
            <h4>Часто используемые</h4>
            <div class="emoji-grid" id="frequentEmojis">
                <!-- Частые эмодзи -->
            </div>
        </div>
        <div class="emoji-category">
            <h4>Смайлики и люди</h4>
            <div class="emoji-grid" id="smileyEmojis">
                <!-- Эмодзи смайликов -->
            </div>
        </div>
    </div>

    <!-- Уведомление -->
    <div class="toast" id="toast"></div>

    <script>
        // Глобальные переменные
        let currentUser = null;
        let currentChat = null;
        let chats = new Map();
        let usersCache = new Map();
        let selectedAvatarFile = null;
        let searchTimeout = null;

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', async function() {
            // Ждем загрузки Firebase
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Проверяем авторизацию
            if (window.firebase && window.firebase.onAuthStateChanged) {
                window.firebase.onAuthStateChanged(window.firebase.auth, async (user) => {
                    if (user) {
                        // Пользователь авторизован
                        await loadUserData(user.uid);
                        showMainApp();
                    } else {
                        // Пользователь не авторизован
                        document.getElementById('loadingScreen').classList.add('hidden');
                        document.getElementById('authScreen').classList.remove('hidden');
                    }
                });
            } else {
                // Firebase не загрузился, показываем ошибку
                showToast('Ошибка загрузки Firebase. Пожалуйста, обновите страницу.', 'error');
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('authScreen').classList.remove('hidden');
            }
            
            // Инициализация эмодзи
            initializeEmojis();
            
            // Настройка модального окна
            setupModal();
        });

        // Настройка модального окна
        function setupModal() {
            const modalOverlay = document.getElementById('modalOverlay');
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === modalOverlay) {
                    closeModal();
                }
            });
        }

        // Переключение между вкладками авторизации
        function switchAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const tabs = document.querySelectorAll('.auth-tab');
            
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            }
            
            // Очищаем ошибки
            clearErrors();
        }

        // Очистка ошибок
        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.classList.remove('show');
                el.textContent = '';
            });
        }

        // Показать ошибку
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.classList.add('show');
            }
        }

        // Вход пользователя
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginButton = document.getElementById('loginButton');
            
            // Валидация
            clearErrors();
            let hasError = false;
            
            if (!email) {
                showError('loginEmailError', 'Введите email');
                hasError = true;
            }
            
            if (!password) {
                showError('loginPasswordError', 'Введите пароль');
                hasError = true;
            }
            
            if (hasError) return;
            
            // Блокируем кнопку
            loginButton.innerHTML = '<span class="loader"></span> Вход...';
            loginButton.disabled = true;
            
            try {
                const userCredential = await window.firebase.signInWithEmailAndPassword(
                    window.firebase.auth,
                    email,
                    password
                );
                
                showToast('Успешный вход!', 'success');
                
            } catch (error) {
                console.error('Login error:', error);
                
                let errorMessage = 'Ошибка входа';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'Пользователь не найден';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Неверный пароль';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Неверный формат email';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'Аккаунт отключен';
                        break;
                }
                
                showError('loginPasswordError', errorMessage);
                showToast(errorMessage, 'error');
                
                // Восстанавливаем кнопку
                loginButton.innerHTML = 'Войти';
                loginButton.disabled = false;
            }
        }

        // Регистрация пользователя
        async function register() {
            const username = document.getElementById('regUsername').value.trim().toLowerCase();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const registerButton = document.getElementById('registerButton');
            
            // Валидация
            clearErrors();
            let hasError = false;
            
            if (!username) {
                showError('regUsernameError', 'Введите никнейм');
                hasError = true;
            } else if (username.length < 3) {
                showError('regUsernameError', 'Никнейм должен быть не менее 3 символов');
                hasError = true;
            } else if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showError('regUsernameError', 'Никнейм может содержать только буквы, цифры и подчеркивания');
                hasError = true;
            }
            
            if (!email) {
                showError('regEmailError', 'Введите email');
                hasError = true;
            } else if (!email.includes('@')) {
                showError('regEmailError', 'Введите корректный email');
                hasError = true;
            }
            
            if (!password) {
                showError('regPasswordError', 'Введите пароль');
                hasError = true;
            } else if (password.length < 6) {
                showError('regPasswordError', 'Пароль должен быть не менее 6 символов');
                hasError = true;
            }
            
            if (!confirmPassword) {
                showError('regConfirmPasswordError', 'Подтвердите пароль');
                hasError = true;
            } else if (password !== confirmPassword) {
                showError('regConfirmPasswordError', 'Пароли не совпадают');
                hasError = true;
            }
            
            if (hasError) return;
            
            // Проверяем уникальность никнейма
            try {
                const usersQuery = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'users'),
                    window.firebase.where('username', '==', username.toLowerCase())
                );
                const querySnapshot = await window.firebase.getDocs(usersQuery);
                
                if (!querySnapshot.empty) {
                    showError('regUsernameError', 'Этот никнейм уже занят');
                    return;
                }
            } catch (error) {
                console.error('Username check error:', error);
                showError('regUsernameError', 'Ошибка проверки никнейма');
                return;
            }
            
            // Блокируем кнопку
            registerButton.innerHTML = '<span class="loader"></span> Регистрация...';
            registerButton.disabled = true;
            
            try {
                // Создаем пользователя в Firebase Auth
                const userCredential = await window.firebase.createUserWithEmailAndPassword(
                    window.firebase.auth,
                    email,
                    password
                );
                
                const user = userCredential.user;
                
                // Создаем профиль пользователя в Firestore
                const userData = {
                    uid: user.uid,
                    username: username.toLowerCase(),
                    displayName: username,
                    email: email,
                    bio: '',
                    avatarUrl: '',
                    createdAt: window.firebase.serverTimestamp(),
                    lastSeen: window.firebase.serverTimestamp(),
                    status: 'online'
                };
                
                await window.firebase.setDoc(
                    window.firebase.doc(window.firebase.db, 'users', user.uid),
                    userData
                );
                
                showToast('Регистрация успешна!', 'success');
                
            } catch (error) {
                console.error('Registration error:', error);
                
                let errorMessage = 'Ошибка регистрации';
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Этот email уже используется';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Неверный формат email';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Пароль слишком слабый';
                        break;
                }
                
                showError('regEmailError', errorMessage);
                showToast(errorMessage, 'error');
                
                // Восстанавливаем кнопку
                registerButton.innerHTML = 'Зарегистрироваться';
                registerButton.disabled = false;
            }
        }

        // Функция для проверки подключения к Firebase
        async function checkFirebaseConnection() {
            try {
                console.log('Checking Firebase connection...');
                
                // Проверяем аутентификацию
                const auth = window.firebase.auth;
                console.log('Auth state:', auth.currentUser);
                
                // Проверяем Firestore
                const testQuery = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'users'),
                    window.firebase.limit(1)
                );
                
                const testSnapshot = await window.firebase.getDocs(testQuery);
                console.log('Firestore connection test:', testSnapshot.empty ? 'No users found' : 'Connected');
                
                return true;
            } catch (error) {
                console.error('Firebase connection error:', error);
                return false;
            }
        }

        // Загрузка данных пользователя
        async function loadUserData(userId) {
            try {
                // Проверяем подключение
                const isConnected = await checkFirebaseConnection();
                if (!isConnected) {
                    showToast('Проверьте подключение к интернету', 'error');
                    return;
                }
                
                const userDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.firebase.db, 'users', userId)
                );
                
                if (userDoc.exists()) {
                    currentUser = { id: userId, ...userDoc.data() };
                    console.log('User loaded:', currentUser);
                    
                    updateUserInterface();
                    
                    // Загружаем чаты пользователя
                    await loadUserChats();
                    
                    // Обновляем статус на "онлайн"
                    await updateUserStatus('online');
                    
                    // Слушаем изменения в чатах
                    setupChatsListener();
                } else {
                    console.error('User document not found');
                    showToast('Профиль пользователя не найден', 'error');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                let errorMessage = 'Ошибка загрузки данных пользователя';
                if (error.code === 'permission-denied') {
                    errorMessage = 'Нет доступа к данным. Выйдите и войдите снова.';
                }
                
                showToast(errorMessage, 'error');
            }
        }

        // Обновление статуса пользователя
        async function updateUserStatus(status) {
            if (!currentUser) return;
            
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.firebase.db, 'users', currentUser.id),
                    {
                        status: status,
                        lastSeen: window.firebase.serverTimestamp()
                    }
                );
            } catch (error) {
                console.error('Error updating user status:', error);
            }
        }

        // Загрузка чатов пользователя - ИСПРАВЛЕННАЯ ВЕРСИЯ
        async function loadUserChats() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error('No current user found');
                    return;
                }

                console.log('Loading chats for user:', currentUser.id);
                
                const chatsQuery = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'chats'),
                    window.firebase.where('participants', 'array-contains', currentUser.id)
                );
                
                const querySnapshot = await window.firebase.getDocs(chatsQuery);
                const chatsList = document.getElementById('chatsList');
                
                console.log('Found', querySnapshot.size, 'chats');
                
                if (querySnapshot.empty) {
                    chatsList.innerHTML = `
                        <div class="no-chats">
                            <i class="fas fa-comments"></i>
                            <h3>Нет чатов</h3>
                            <p>Начните общение, найдя пользователей через поиск</p>
                        </div>
                    `;
                    return;
                }
                
                // Создаем контейнер для чатов
                const chatContainer = document.createElement('div');
                
                for (const doc of querySnapshot.docs) {
                    const chat = { 
                        id: doc.id, 
                        ...doc.data(),
                        lastMessageTime: doc.data().lastMessageTime || new Date(0)
                    };
                    
                    console.log('Processing chat:', chat.id, chat.participants);
                    
                    // Получаем информацию о собеседнике
                    const otherParticipantId = chat.participants.find(id => id !== currentUser.id);
                    if (otherParticipantId) {
                        try {
                            const userData = await getUserData(otherParticipantId);
                            chat.otherUser = userData;
                            
                            const chatElement = createChatElement(chat);
                            chatContainer.appendChild(chatElement);
                            
                            // Сохраняем чат в Map
                            chats.set(chat.id, chat);
                        } catch (userError) {
                            console.error('Error loading user data for', otherParticipantId, userError);
                        }
                    }
                }
                
                chatsList.innerHTML = '';
                chatsList.appendChild(chatContainer);
                
            } catch (error) {
                console.error('Error loading chats:', error);
                console.error('Error details:', error.code, error.message);
                
                // Показываем более информативное сообщение об ошибке
                let errorMessage = 'Ошибка загрузки чатов';
                if (error.code === 'permission-denied') {
                    errorMessage = 'Нет доступа к чатам. Пожалуйста, проверьте правила Firestore.';
                    console.log('ВАЖНО: Установите следующие правила Firestore:');
                    console.log(`
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /chats/{chatId} {
      allow read: if request.auth != null && 
        (resource.data.participants.hasAny([request.auth.uid]));
      allow create: if request.auth != null;
      allow update: if request.auth != null && 
        (resource.data.participants.hasAny([request.auth.uid]));
      
      match /messages/{messageId} {
        allow read: if request.auth != null && 
          (get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]));
        allow create: if request.auth != null && 
          (get(/databases/$(database)/documents/chats/$(chatId)).data.participants.hasAny([request.auth.uid]));
      }
    }
  }
}
                    `);
                } else if (error.code === 'unavailable') {
                    errorMessage = 'Нет подключения к интернету';
                }
                
                showToast(errorMessage, 'error');
                
                // Показываем сообщение об ошибке в интерфейсе
                const chatsList = document.getElementById('chatsList');
                chatsList.innerHTML = `
                    <div class="no-chats">
                        <i class="fas fa-exclamation-triangle" style="color: #ff4444;"></i>
                        <h3>${errorMessage}</h3>
                        <p>Попробуйте перезагрузить страницу</p>
                    </div>
                `;
            }
        }

        // Создание тестовых данных (если нужно)
        async function createTestData() {
            if (!currentUser) return;
            
            try {
                // Создаем тестового пользователя
                const testUserId = 'test_user_' + Date.now();
                const testUserData = {
                    uid: testUserId,
                    username: 'testuser',
                    displayName: 'Тестовый пользователь',
                    email: 'test@example.com',
                    bio: 'Это тестовый аккаунт',
                    avatarUrl: '',
                    createdAt: window.firebase.serverTimestamp(),
                    lastSeen: window.firebase.serverTimestamp(),
                    status: 'online'
                };
                
                await window.firebase.setDoc(
                    window.firebase.doc(window.firebase.db, 'users', testUserId),
                    testUserData
                );
                
                // Создаем тестовый чат
                const chatData = {
                    participants: [currentUser.id, testUserId],
                    createdAt: window.firebase.serverTimestamp(),
                    lastMessage: 'Привет! Это тестовое сообщение',
                    lastMessageTime: window.firebase.serverTimestamp(),
                    unreadCount: 1
                };
                
                const chatRef = await window.firebase.addDoc(
                    window.firebase.collection(window.firebase.db, 'chats'),
                    chatData
                );
                
                // Добавляем тестовое сообщение
                const messageData = {
                    text: 'Привет! Это тестовое сообщение',
                    senderId: testUserId,
                    timestamp: window.firebase.serverTimestamp(),
                    read: false
                };
                
                await window.firebase.addDoc(
                    window.firebase.collection(window.firebase.db, 'chats', chatRef.id, 'messages'),
                    messageData
                );
                
                showToast('Тестовые данные созданы', 'success');
                await loadUserChats();
                
            } catch (error) {
                console.error('Error creating test data:', error);
                showToast('Ошибка создания тестовых данных', 'error');
            }
        }

        // Настройка слушателя чатов
        function setupChatsListener() {
            if (!currentUser) return;
            
            try {
                const chatsQuery = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'chats'),
                    window.firebase.where('participants', 'array-contains', currentUser.id)
                );
                
                window.firebase.onSnapshot(chatsQuery, (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added' || change.type === 'modified') {
                            const chat = { id: change.doc.id, ...change.doc.data() };
                            chats.set(chat.id, chat);
                            
                            // Получаем информацию о собеседнике
                            const otherParticipantId = chat.participants.find(id => id !== currentUser.id);
                            if (otherParticipantId && !chat.otherUser) {
                                const userData = await getUserData(otherParticipantId);
                                chat.otherUser = userData;
                            }
                            
                            updateChatsList();
                        } else if (change.type === 'removed') {
                            chats.delete(change.doc.id);
                            updateChatsList();
                        }
                    });
                });
            } catch (error) {
                console.error('Error setting up chats listener:', error);
            }
        }

        // Получение данных пользователя
        async function getUserData(userId) {
            // Проверяем кэш
            if (usersCache.has(userId)) {
                return usersCache.get(userId);
            }
            
            try {
                const userDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.firebase.db, 'users', userId)
                );
                
                if (userDoc.exists()) {
                    const userData = { id: userId, ...userDoc.data() };
                    usersCache.set(userId, userData);
                    return userData;
                }
            } catch (error) {
                console.error('Error getting user data:', error);
            }
            
            return null;
        }

        // Обновление списка чатов
        function updateChatsList() {
            const chatsList = document.getElementById('chatsList');
            
            if (chats.size === 0) {
                chatsList.innerHTML = `
                    <div class="no-chats">
                        <i class="fas fa-comments"></i>
                        <h3>Нет чатов</h3>
                        <p>Начните общение, найдя пользователей через поиск</p>
                    </div>
                `;
                return;
            }
            
            // Сортируем чаты по времени последнего сообщения
            const sortedChats = Array.from(chats.values()).sort((a, b) => {
                const timeA = a.lastMessageTime?.toDate?.() || new Date(0);
                const timeB = b.lastMessageTime?.toDate?.() || new Date(0);
                return timeB - timeA;
            });
            
            // Создаем новый список
            const chatContainer = document.createElement('div');
            
            sortedChats.forEach(chat => {
                if (chat.otherUser) {
                    const chatElement = createChatElement(chat);
                    
                    // Если это текущий чат, помечаем как активный
                    if (currentChat && currentChat.id === chat.id) {
                        chatElement.classList.add('active');
                    }
                    
                    chatContainer.appendChild(chatElement);
                }
            });
            
            chatsList.innerHTML = '';
            chatsList.appendChild(chatContainer);
        }

        // Создание элемента чата
        function createChatElement(chat) {
            const chatElement = document.createElement('div');
            chatElement.className = 'chat-item';
            chatElement.dataset.chatId = chat.id;
            chatElement.onclick = () => selectChat(chat.id);
            
            const otherUser = chat.otherUser;
            const lastMessage = chat.lastMessage || 'Нет сообщений';
            const timestamp = chat.lastMessageTime ? formatTime(chat.lastMessageTime.toDate()) : '';
            const unreadCount = chat.unreadCount || 0;
            
            chatElement.innerHTML = `
                <div class="chat-avatar" style="${otherUser?.avatarUrl ? `background-image: url('${otherUser.avatarUrl}')` : ''}">
                    ${otherUser?.avatarUrl ? '' : (otherUser?.displayName?.charAt(0) || '?')}
                </div>
                <div class="chat-info">
                    <div class="chat-header">
                        <span class="chat-name">${otherUser?.displayName || 'Неизвестный пользователь'}</span>
                        <span class="chat-time">${timestamp}</span>
                    </div>
                    <div class="chat-preview">${lastMessage}</div>
                </div>
                ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
            `;
            
            return chatElement;
        }

        // Выбор чата
        async function selectChat(chatId) {
            const chat = chats.get(chatId);
            if (!chat) return;
            
            currentChat = chat;
            
            // Обновляем активный чат в списке
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Показываем элементы чата
            document.getElementById('chatHeader').classList.remove('hidden');
            document.getElementById('noChatSelected').classList.add('hidden');
            document.getElementById('messageInputArea').classList.remove('hidden');
            
            // Обновляем информацию о чате
            const otherUser = chat.otherUser || await getUserData(
                chat.participants.find(id => id !== currentUser.id)
            );
            
            if (otherUser) {
                chat.otherUser = otherUser;
                updateChatHeader(otherUser);
            }
            
            // Загружаем сообщения
            await loadMessages();
            
            // Сбрасываем непрочитанные сообщения
            await markChatAsRead(chatId);
        }

        // Обновление заголовка чата
        function updateChatHeader(user) {
            document.getElementById('currentChatName').textContent = user.displayName || user.username;
            document.getElementById('currentChatAvatar').style.backgroundImage = user.avatarUrl ? `url('${user.avatarUrl}')` : '';
            document.getElementById('currentChatAvatar').textContent = user.avatarUrl ? '' : (user.displayName?.charAt(0) || user.username?.charAt(0) || '?');
            document.getElementById('currentChatStatus').textContent = user.status === 'online' ? 'онлайн' : 'был(а) недавно';
        }

        // Загрузка сообщений
        async function loadMessages() {
            if (!currentChat) return;
            
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';
            
            try {
                const messagesQuery = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'chats', currentChat.id, 'messages'),
                    window.firebase.orderBy('timestamp', 'asc')
                );
                
                const querySnapshot = await window.firebase.getDocs(messagesQuery);
                
                if (querySnapshot.empty) {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-comment-slash" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <p>Нет сообщений</p>
                            <p style="font-size: 14px; margin-top: 10px;">Начните общение!</p>
                        </div>
                    `;
                    return;
                }
                
                let lastDate = null;
                querySnapshot.forEach((doc) => {
                    const message = { id: doc.id, ...doc.data() };
                    
                    // Добавляем разделитель даты
                    const messageDate = message.timestamp.toDate();
                    const dateStr = messageDate.toLocaleDateString();
                    
                    if (lastDate !== dateStr) {
                        const dateElement = document.createElement('div');
                        dateElement.className = 'message-date';
                        dateElement.innerHTML = `<span>${formatDate(messageDate)}</span>`;
                        messagesContainer.appendChild(dateElement);
                        lastDate = dateStr;
                    }
                    
                    // Добавляем сообщение
                    const messageElement = createMessageElement(message);
                    messagesContainer.appendChild(messageElement);
                });
                
                // Прокручиваем вниз
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
            } catch (error) {
                console.error('Error loading messages:', error);
                showToast('Ошибка загрузки сообщений', 'error');
            }
        }

        // Создание элемента сообщения
        function createMessageElement(message) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.senderId === currentUser.id ? 'outgoing' : ''}`;
            
            const time = message.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            if (message.senderId === currentUser.id) {
                messageElement.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">${time}</div>
                    </div>
                    <div class="message-avatar" style="${currentUser.avatarUrl ? `background-image: url('${currentUser.avatarUrl}')` : ''}">
                        ${currentUser.avatarUrl ? '' : (currentUser.displayName?.charAt(0) || currentUser.username?.charAt(0) || '?')}
                    </div>
                `;
            } else {
                const sender = currentChat?.otherUser;
                messageElement.innerHTML = `
                    <div class="message-avatar" style="${sender?.avatarUrl ? `background-image: url('${sender.avatarUrl}')` : ''}">
                        ${sender?.avatarUrl ? '' : (sender?.displayName?.charAt(0) || sender?.username?.charAt(0) || '?')}
                    </div>
                    <div class="message-content">
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            }
            
            return messageElement;
        }

        // Отправка сообщения
        async function sendMessage() {
            if (!currentChat) {
                showToast('Выберите чат для отправки сообщения', 'error');
                return;
            }
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) {
                showToast('Введите сообщение', 'error');
                return;
            }
            
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.innerHTML = '<span class="loader"></span>';
            
            try {
                // Используем транзакцию для атомарного обновления
                await window.firebase.runTransaction(window.firebase.db, async (transaction) => {
                    // Ссылки на документы
                    const chatRef = window.firebase.doc(window.firebase.db, 'chats', currentChat.id);
                    const messagesRef = window.firebase.collection(window.firebase.db, 'chats', currentChat.id, 'messages');
                    
                    // Получаем текущий чат
                    const chatDoc = await transaction.get(chatRef);
                    if (!chatDoc.exists()) {
                        throw new Error('Чат не найден');
                    }
                    
                    // Создаем новое сообщение
                    const messageData = {
                        text: text,
                        senderId: currentUser.id,
                        timestamp: window.firebase.serverTimestamp(),
                        read: false
                    };
                    
                    // Добавляем сообщение
                    const newMessageRef = window.firebase.doc(messagesRef);
                    transaction.set(newMessageRef, messageData);
                    
                    // Обновляем информацию о чате
                    transaction.update(chatRef, {
                        lastMessage: text,
                        lastMessageTime: window.firebase.serverTimestamp(),
                        unreadCount: window.firebase.increment(1)
                    });
                });
                
                // Очищаем поле ввода
                input.value = '';
                autoResizeTextarea(input);
                
                // Фокус на поле ввода
                input.focus();
                
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Ошибка отправки сообщения', 'error');
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        // Отметить чат как прочитанный
        async function markChatAsRead(chatId) {
            try {
                // Обновляем счетчик непрочитанных
                await window.firebase.updateDoc(
                    window.firebase.doc(window.firebase.db, 'chats', chatId),
                    {
                        unreadCount: 0
                    }
                );
                
                // Обновляем элемент чата
                const chat = chats.get(chatId);
                if (chat) {
                    chat.unreadCount = 0;
                    updateChatsList();
                }
                
            } catch (error) {
                console.error('Error marking chat as read:', error);
            }
        }

        // Поиск пользователей в сайдбаре
        async function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (searchTerm.length < 2) {
                // Если поиск пустой, показываем чаты
                updateChatsList();
                return;
            }
            
            try {
                // Ищем пользователей по никнейму или отображаемому имени
                const usersQuery = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'users'),
                    window.firebase.where('username', '>=', searchTerm),
                    window.firebase.where('username', '<=', searchTerm + '\uf8ff')
                );
                
                const querySnapshot = await window.firebase.getDocs(usersQuery);
                const chatsList = document.getElementById('chatsList');
                chatsList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    chatsList.innerHTML = `
                        <div class="no-chats">
                            <i class="fas fa-search"></i>
                            <h3>Пользователи не найдены</h3>
                            <p>Попробуйте другой поисковый запрос</p>
                        </div>
                    `;
                    return;
                }
                
                const resultsContainer = document.createElement('div');
                
                querySnapshot.forEach((doc) => {
                    const user = { id: doc.id, ...doc.data() };
                    
                    // Пропускаем текущего пользователя
                    if (user.id === currentUser.id) return;
                    
                    const userElement = createUserSearchElement(user);
                    resultsContainer.appendChild(userElement);
                });
                
                chatsList.appendChild(resultsContainer);
                
            } catch (error) {
                console.error('Error searching users:', error);
                showToast('Ошибка поиска пользователей', 'error');
            }
        }

        // Создание элемента результата поиска пользователя
        function createUserSearchElement(user) {
            const userElement = document.createElement('div');
            userElement.className = 'chat-item';
            userElement.onclick = async () => {
                await createOrOpenChat(user);
            };
            
            userElement.innerHTML = `
                <div class="chat-avatar" style="${user.avatarUrl ? `background-image: url('${user.avatarUrl}')` : ''}">
                    ${user.avatarUrl ? '' : (user.displayName?.charAt(0) || user.username?.charAt(0))}
                </div>
                <div class="chat-info">
                    <div class="chat-header">
                        <span class="chat-name">${user.displayName || user.username}</span>
                        <span class="chat-time">${user.status === 'online' ? 'онлайн' : ''}</span>
                    </div>
                    <div class="chat-preview">@${user.username}</div>
                </div>
                <div class="unread-badge" style="background: #4caf50;">+</div>
            `;
            
            return userElement;
        }

        // Создание или открытие чата
        async function createOrOpenChat(otherUser) {
            try {
                // Проверяем, существует ли уже чат
                const chatsQuery = window.firebase.query(
                    window.firebase.collection(window.firebase.db, 'chats'),
                    window.firebase.where('participants', 'array-contains', currentUser.id)
                );
                
                const querySnapshot = await window.firebase.getDocs(chatsQuery);
                
                let existingChat = null;
                for (const doc of querySnapshot.docs) {
                    const chat = doc.data();
                    if (chat.participants.includes(otherUser.id)) {
                        existingChat = { id: doc.id, ...chat };
                        break;
                    }
                }
                
                if (existingChat) {
                    // Открываем существующий чат
                    const chatElement = document.querySelector(`[data-chat-id="${existingChat.id}"]`);
                    if (chatElement) {
                        chatElement.click();
                    } else {
                        // Добавляем чат в список и выбираем его
                        existingChat.otherUser = otherUser;
                        chats.set(existingChat.id, existingChat);
                        updateChatsList();
                        
                        // Находим и кликаем на элемент
                        setTimeout(() => {
                            const newChatElement = document.querySelector(`[data-chat-id="${existingChat.id}"]`);
                            if (newChatElement) {
                                newChatElement.click();
                            }
                        }, 100);
                    }
                } else {
                    // Создаем новый чат
                    const chatData = {
                        participants: [currentUser.id, otherUser.id],
                        createdAt: window.firebase.serverTimestamp(),
                        lastMessage: '',
                        lastMessageTime: window.firebase.serverTimestamp(),
                        unreadCount: 0
                    };
                    
                    const chatRef = await window.firebase.addDoc(
                        window.firebase.collection(window.firebase.db, 'chats'),
                        chatData
                    );
                    
                    // Создаем объект чата
                    const newChat = {
                        id: chatRef.id,
                        ...chatData,
                        otherUser: otherUser
                    };
                    
                    chats.set(newChat.id, newChat);
                    updateChatsList();
                    
                    // Выбираем новый чат
                    setTimeout(() => {
                        const newChatElement = document.querySelector(`[data-chat-id="${newChat.id}"]`);
                        if (newChatElement) {
                            newChatElement.click();
                        }
                    }, 100);
                    
                    showToast(`Чат с ${otherUser.displayName || otherUser.username} создан`, 'success');
                }
                
                // Закрываем модальное окно, если оно открыто
                closeModal();
                
            } catch (error) {
                console.error('Error creating/opening chat:', error);
                showToast('Ошибка создания чата', 'error');
            }
        }

        // Показать главное приложение
        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
        }

        // Обновление интерфейса пользователя
        function updateUserInterface() {
            if (!currentUser) return;
            
            // Обновляем аватар и имя в сайдбаре
            const currentUserAvatar = document.getElementById('currentUserAvatar');
            currentUserAvatar.style.backgroundImage = currentUser.avatarUrl ? `url('${currentUser.avatarUrl}')` : '';
            currentUserAvatar.textContent = currentUser.avatarUrl ? '' : 
                (currentUser.displayName?.charAt(0) || currentUser.username?.charAt(0) || '?');
            
            document.getElementById('currentUserName').textContent = currentUser.displayName || currentUser.username;
            
            // Обновляем аватар и имя в меню
            const menuUserAvatar = document.getElementById('menuUserAvatar');
            menuUserAvatar.style.backgroundImage = currentUser.avatarUrl ? `url('${currentUser.avatarUrl}')` : '';
            menuUserAvatar.textContent = currentUser.avatarUrl ? '' : 
                (currentUser.displayName?.charAt(0) || currentUser.username?.charAt(0) || '?');
            
            document.getElementById('menuUserName').textContent = currentUser.displayName || currentUser.username;
            document.getElementById('menuUserEmail').textContent = currentUser.email;
            
            // Обновляем аватар в превью профиля
            const avatarPreview = document.getElementById('avatarPreview');
            avatarPreview.style.backgroundImage = currentUser.avatarUrl ? `url('${currentUser.avatarUrl}')` : '';
            avatarPreview.textContent = currentUser.avatarUrl ? '' : 
                (currentUser.displayName?.charAt(0) || currentUser.username?.charAt(0) || '?');
            
            // Заполняем поля формы профиля
            document.getElementById('profileUsername').value = currentUser.username || '';
            document.getElementById('profileDisplayName').value = currentUser.displayName || '';
            document.getElementById('profileBio').value = currentUser.bio || '';
        }

        // Открыть меню
        function openMenu() {
            document.getElementById('sideMenu').classList.add('active');
            document.getElementById('menuOverlay').classList.add('active');
        }

        // Закрыть меню
        function closeMenu() {
            document.getElementById('sideMenu').classList.remove('active');
            document.getElementById('menuOverlay').classList.remove('active');
        }

        // Показать настройки профиля
        function showProfileSettings() {
            closeMenu();
            openModal('profileModal');
        }

        // Открыть модальное окно
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Закрыть модальное окно
        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.add('hidden');
            });
            document.getElementById('modalOverlay').classList.remove('active');
            document.body.style.overflow = '';
            selectedAvatarFile = null;
            
            // Очищаем результаты поиска
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = `
                <div class="no-search-results">
                    <i class="fas fa-search" style="font-size: 32px; margin-bottom: 10px; color: #ccc;"></i>
                    <p>Начните вводить никнейм для поиска</p>
                </div>
            `;
        }

        // Показать модальное окно нового чата
        function showNewChatModal() {
            closeMenu();
            openModal('newChatModal');
            document.getElementById('userSearchInput').focus();
        }

        // Триггер загрузки аватарки
        function triggerAvatarUpload() {
            document.getElementById('avatarInput').click();
        }

        // Обработка загрузки аватарки
        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Проверяем тип файла
            if (!file.type.startsWith('image/')) {
                showToast('Пожалуйста, выберите изображение', 'error');
                return;
            }
            
            // Проверяем размер файла (максимум 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Размер файла не должен превышать 5MB', 'error');
                return;
            }
            
            selectedAvatarFile = file;
            
            // Показываем превью
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').style.backgroundImage = `url('${e.target.result}')`;
                document.getElementById('avatarPreview').textContent = '';
            };
            reader.readAsDataURL(file);
        }

        // Обновление профиля
        async function updateProfile() {
            const username = document.getElementById('profileUsername').value.trim().toLowerCase();
            const displayName = document.getElementById('profileDisplayName').value.trim();
            const bio = document.getElementById('profileBio').value.trim();
            const updateButton = document.getElementById('updateProfileButton');
            
            // Валидация
            clearErrors();
            let hasError = false;
            
            if (!username) {
                showError('profileUsernameError', 'Введите никнейм');
                hasError = true;
            } else if (username.length < 3) {
                showError('profileUsernameError', 'Никнейм должен быть не менее 3 символов');
                hasError = true;
            } else if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showError('profileUsernameError', 'Никнейм может содержать только буквы, цифры и подчеркивания');
                hasError = true;
            }
            
            if (hasError) return;
            
            // Проверяем уникальность никнейма (если изменился)
            if (username !== currentUser.username) {
                try {
                    const usersQuery = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'users'),
                        window.firebase.where('username', '==', username)
                    );
                    const querySnapshot = await window.firebase.getDocs(usersQuery);
                    
                    if (!querySnapshot.empty) {
                        showError('profileUsernameError', 'Этот никнейм уже занят');
                        return;
                    }
                } catch (error) {
                    console.error('Username check error:', error);
                    showError('profileUsernameError', 'Ошибка проверки никнейма');
                    return;
                }
            }
            
            updateButton.innerHTML = '<span class="loader"></span> Сохранение...';
            updateButton.disabled = true;
            
            try {
                const updateData = {
                    username: username,
                    displayName: displayName || username,
                    bio: bio,
                    updatedAt: window.firebase.serverTimestamp()
                };
                
                // Загружаем аватарку, если она выбрана
                if (selectedAvatarFile) {
                    const avatarRef = window.firebase.ref(
                        window.firebase.storage,
                        `avatars/${currentUser.id}/${Date.now()}_${selectedAvatarFile.name}`
                    );
                    
                    await window.firebase.uploadBytes(avatarRef, selectedAvatarFile);
                    const downloadURL = await window.firebase.getDownloadURL(avatarRef);
                    updateData.avatarUrl = downloadURL;
                }
                
                // Обновляем профиль в Firestore
                await window.firebase.updateDoc(
                    window.firebase.doc(window.firebase.db, 'users', currentUser.id),
                    updateData
                );
                
                // Обновляем локальные данные
                currentUser = { ...currentUser, ...updateData };
                usersCache.set(currentUser.id, currentUser);
                
                // Обновляем интерфейс
                updateUserInterface();
                
                showToast('Профиль успешно обновлен', 'success');
                closeModal();
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('Ошибка обновления профиля', 'error');
            } finally {
                updateButton.innerHTML = 'Сохранить';
                updateButton.disabled = false;
            }
        }

        // Поиск пользователей для чата
        async function searchUsersForChat() {
            clearTimeout(searchTimeout);
            
            const searchTerm = document.getElementById('userSearchInput').value.trim().toLowerCase();
            const searchResults = document.getElementById('searchResults');
            
            if (searchTerm.length < 2) {
                searchResults.innerHTML = `
                    <div class="no-search-results">
                        <i class="fas fa-search" style="font-size: 32px; margin-bottom: 10px; color: #ccc;"></i>
                        <p>Введите минимум 2 символа для поиска</p>
                    </div>
                `;
                return;
            }
            
            searchResults.innerHTML = `
                <div class="search-loading">
                    <div class="loader"></div>
                    <p>Поиск пользователей...</p>
                </div>
            `;
            
            searchTimeout = setTimeout(async () => {
                try {
                    // Ищем пользователей по никнейму или отображаемому имени
                    const usersQuery = window.firebase.query(
                        window.firebase.collection(window.firebase.db, 'users'),
                        window.firebase.where('username', '>=', searchTerm),
                        window.firebase.where('username', '<=', searchTerm + '\uf8ff')
                    );
                    
                    const querySnapshot = await window.firebase.getDocs(usersQuery);
                    
                    if (querySnapshot.empty) {
                        searchResults.innerHTML = `
                            <div class="no-search-results">
                                <i class="fas fa-user-slash" style="font-size: 32px; margin-bottom: 10px; color: #ccc;"></i>
                                <p>Пользователи не найдены</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let resultsHTML = '';
                    let foundUsers = 0;
                    
                    querySnapshot.forEach((doc) => {
                        const user = { id: doc.id, ...doc.data() };
                        
                        // Пропускаем текущего пользователя
                        if (user.id === currentUser.id) return;
                        
                        foundUsers++;
                        
                        resultsHTML += `
                            <div class="user-search-item" onclick="selectUserForChat('${user.id}')">
                                <div class="user-search-avatar" style="${user.avatarUrl ? `background-image: url('${user.avatarUrl}')` : ''}">
                                    ${user.avatarUrl ? '' : (user.displayName?.charAt(0) || user.username?.charAt(0))}
                                </div>
                                <div class="user-search-info">
                                    <div class="user-search-name">${user.displayName || user.username}</div>
                                    <div class="user-search-username">@${user.username}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    if (foundUsers === 0) {
                        searchResults.innerHTML = `
                            <div class="no-search-results">
                                <i class="fas fa-user-slash" style="font-size: 32px; margin-bottom: 10px; color: #ccc;"></i>
                                <p>Пользователи не найдены</p>
                            </div>
                        `;
                    } else {
                        searchResults.innerHTML = resultsHTML;
                    }
                    
                } catch (error) {
                    console.error('Error searching users:', error);
                    searchResults.innerHTML = `
                        <div class="no-search-results">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 10px; color: #ff4444;"></i>
                            <p>Ошибка поиска</p>
                        </div>
                    `;
                }
            }, 500);
        }

        // Выбор пользователя для чата
        async function selectUserForChat(userId) {
            const user = await getUserData(userId);
            if (user) {
                await createOrOpenChat(user);
            }
        }

        // Показать контакты
        function showContacts() {
            closeMenu();
            showToast('Функция контактов в разработке', 'info');
        }

        // Выйти из аккаунта
        async function logout() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                try {
                    // Обновляем статус на "офлайн"
                    await updateUserStatus('offline');
                    
                    await window.firebase.signOut(window.firebase.auth);
                    showToast('Вы вышли из аккаунта', 'success');
                } catch (error) {
                    console.error('Error signing out:', error);
                    showToast('Ошибка выхода', 'error');
                }
            }
        }

        // Переключение панели информации
        async function toggleInfoPanel() {
            if (!currentChat || !currentChat.otherUser) return;
            
            const panel = document.getElementById('infoPanel');
            panel.classList.toggle('hidden');
            
            if (!panel.classList.contains('hidden')) {
                await updateInfoPanel();
            }
        }

        // Обновление панели информации
        async function updateInfoPanel() {
            if (!currentChat || !currentChat.otherUser) return;
            
            const user = currentChat.otherUser;
            
            const infoAvatar = document.getElementById('infoAvatar');
            infoAvatar.style.backgroundImage = user.avatarUrl ? `url('${user.avatarUrl}')` : '';
            infoAvatar.textContent = user.avatarUrl ? '' : (user.displayName?.charAt(0) || user.username?.charAt(0));
            
            document.getElementById('infoName').textContent = user.displayName || user.username;
            document.getElementById('infoStatus').textContent = user.status === 'online' ? 'онлайн' : 'был(а) недавно';
            document.getElementById('infoUsername').textContent = `@${user.username}`;
            document.getElementById('infoDisplayName').textContent = user.displayName || 'Не указано';
            
            if (user.createdAt && user.createdAt.toDate) {
                const joinDate = user.createdAt.toDate();
                document.getElementById('infoJoinDate').textContent = joinDate.toLocaleDateString('ru-RU', {
                    year: 'numeric',
                    month: 'long'
                });
            }
            
            if (user.bio) {
                document.getElementById('bioSection').style.display = 'block';
                document.getElementById('infoBio').textContent = user.bio;
            } else {
                document.getElementById('bioSection').style.display = 'none';
            }
        }

        // Прикрепить файл
        function attachFile() {
            showToast('Функция прикрепления файла в разработке', 'info');
        }

        // Инициализация эмодзи
        function initializeEmojis() {
            const smileyEmojis = ['😀', '😂', '😊', '😍', '🤔', '😎', '🥳', '😇', '😜', '🤗', '😘', '🥰', '😅', '🙃', '😋', '🤩'];
            const frequentEmojis = ['👍', '❤️', '🔥', '🎉', '🤝', '👏', '🙏', '💯'];
            
            const smileyGrid = document.getElementById('smileyEmojis');
            const frequentGrid = document.getElementById('frequentEmojis');
            
            smileyEmojis.forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'emoji';
                span.textContent = emoji;
                span.onclick = () => insertEmoji(emoji);
                smileyGrid.appendChild(span);
            });
            
            frequentEmojis.forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'emoji';
                span.textContent = emoji;
                span.onclick = () => insertEmoji(emoji);
                frequentGrid.appendChild(span);
            });
        }

        // Переключить палитру эмодзи
        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('show');
        }

        // Вставить эмодзи в сообщение
        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            const cursorPos = input.selectionStart;
            const text = input.value;
            
            input.value = text.substring(0, cursorPos) + emoji + text.substring(cursorPos);
            input.focus();
            input.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
            
            autoResizeTextarea(input);
            document.getElementById('emojiPicker').classList.remove('show');
        }

        // Автоматическое изменение высоты textarea
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Отправка сообщения по Enter
        function handleMessageKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Переключить поиск в чате
        function toggleChatSearch() {
            showToast('Поиск в чате в разработке', 'info');
        }

        // Форматирование времени
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60 * 1000) { // меньше минуты
                return 'только что';
            } else if (diff < 60 * 60 * 1000) { // меньше часа
                const minutes = Math.floor(diff / (60 * 1000));
                return `${minutes} мин`;
            } else if (diff < 24 * 60 * 60 * 1000) { // меньше суток
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString([], { day: 'numeric', month: 'short' });
            }
        }

        // Форматирование даты
        function formatDate(date) {
            const now = new Date();
            const diff = now - date;
            
            if (diff < 24 * 60 * 60 * 1000) { // сегодня
                return 'Сегодня';
            } else if (diff < 48 * 60 * 60 * 1000) { // вчера
                return 'Вчера';
            } else {
                return date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    year: now.getFullYear() !== date.getFullYear() ? 'numeric' : undefined
                });
            }
        }

        // Показать уведомление
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Закрытие эмодзи палитры при клике вне ее
        document.addEventListener('click', function(event) {
            const emojiPicker = document.getElementById('emojiPicker');
            const emojiButton = document.querySelector('.fa-smile')?.closest('button');
            
            if (emojiPicker.classList.contains('show') && 
                emojiButton && 
                !emojiPicker.contains(event.target) && 
                !emojiButton.contains(event.target)) {
                emojiPicker.classList.remove('show');
            }
        });

        // Обработка выхода из приложения
        window.addEventListener('beforeunload', async function() {
            if (currentUser) {
                await updateUserStatus('offline');
            }
        });

        // Обработка ошибок Firebase
        window.addEventListener('error', function(event) {
            if (event.message.includes('firebase')) {
                console.error('Firebase error:', event.error);
                showToast('Ошибка подключения к Firebase', 'error');
            }
        });
    </script>
</body>
</html>
