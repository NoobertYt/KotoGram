<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KotoGram - Мессенджер</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.14.0"></link>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #f8fafc;
            --dark: #1e293b;
            --light: #f1f5f9;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray: #94a3b8;
            --gray-light: #e2e8f0;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --sidebar-width: 350px;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            height: 90vh;
            display: flex;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        /* Авторизация */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
            width: 100%;
        }

        .auth-box {
            width: 100%;
            max-width: 450px;
            padding: 40px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .auth-box h2 {
            text-align: center;
            color: var(--dark);
            margin-bottom: 30px;
            font-size: 28px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: var(--radius);
            overflow: hidden;
            background: var(--light);
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: var(--primary);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 600;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 15px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            background: var(--primary-dark);
        }

        .btn-block {
            width: 100%;
        }

        .btn-logout {
            background: var(--danger);
        }

        .btn-logout:hover {
            background: #dc2626;
        }

        .btn-profile {
            background: var(--warning);
        }

        .btn-profile:hover {
            background: #d97706;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 14px;
        }

        .error-message {
            background: #fee;
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        /* Боковая панель */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--secondary);
            border-right: 1px solid var(--gray-light);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .current-user {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid var(--gray-light);
            cursor: pointer;
            transition: background 0.3s;
        }

        .current-user:hover {
            background: var(--light);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            font-size: 14px;
            color: var(--gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .online-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            margin-right: 5px;
        }

        /* Список пользователей */
        .users-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .users-title {
            padding: 15px 20px;
            font-weight: bold;
            color: var(--dark);
            background: var(--light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .users-count {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .user-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.3s;
            border-bottom: 1px solid var(--gray-light);
        }

        .user-item:hover {
            background: var(--light);
        }

        .user-item.active {
            background: var(--primary);
            color: white;
        }

        .user-item.active .user-item-name {
            color: white;
        }

        .user-item.active .user-item-status {
            color: rgba(255, 255, 255, 0.8);
        }

        .user-item-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            color: white;
            position: relative;
            flex-shrink: 0;
        }

        .user-item-info {
            flex: 1;
            min-width: 0;
        }

        .user-item-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-item-status {
            font-size: 13px;
            color: var(--gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Основной чат */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-header h2 {
            font-size: 20px;
            color: var(--dark);
        }

        .chat-type {
            font-size: 14px;
            color: var(--gray);
            margin-top: 5px;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--light);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 15px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            background: white;
            color: var(--dark);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .message-sender {
            font-weight: bold;
        }

        .message-time {
            opacity: 0.8;
            font-size: 12px;
        }

        .message-text {
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 16px;
        }

        .emoji-large {
            font-size: 48px;
            line-height: 1;
        }

        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 5px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .message-image:hover {
            transform: scale(1.02);
        }

        .message-status {
            text-align: right;
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.7;
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid var(--gray-light);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-tools {
            display: flex;
            gap: 10px;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--dark);
            transition: all 0.3s;
        }

        .tool-btn:hover, .tool-btn.active {
            background: var(--primary);
            color: white;
        }

        .message-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 16px;
            transition: border 0.3s;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            font-family: inherit;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: var(--primary-dark);
        }

        .emoji-picker-container {
            position: absolute;
            bottom: 100px;
            right: 30px;
            z-index: 100;
            display: none;
            box-shadow: var(--shadow);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .file-upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .file-upload-box {
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
        }

        .file-upload-box h3 {
            margin-bottom: 20px;
            color: var(--dark);
        }

        .file-preview {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            border: 2px dashed var(--gray);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 100%;
        }

        .upload-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .welcome-message {
            text-align: center;
            color: var(--gray);
            padding: 40px;
            font-size: 18px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            color: var(--dark);
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Загрузка аватара */
        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .avatar-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--primary);
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            color: var(--primary);
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-btn {
            position: relative;
            overflow: hidden;
        }

        .upload-btn input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .avatar-colors {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: transform 0.3s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: var(--dark);
        }

        .status-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .status-option {
            padding: 10px 20px;
            border: 2px solid var(--gray-light);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .status-option.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        /* Адаптивность */
        @media (max-width: 1024px) {
            .container {
                height: 95vh;
            }
            
            .sidebar {
                width: 300px;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 95vh;
            }
            
            .sidebar {
                width: 100%;
                flex: 0 0 auto;
                max-height: 40vh;
            }
            
            .chat-main {
                flex: 1;
            }
            
            .message {
                max-width: 85%;
            }
            
            .emoji-picker-container {
                right: 10px;
                bottom: 90px;
            }
        }

        .unread-badge {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: auto;
        }

        /* Полноэкранное изображение */
        .fullscreen-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .fullscreen-image img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }

        .close-fullscreen {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Авторизация -->
        <div class="auth-container" id="authContainer">
            <div class="auth-box">
                <h2><i class="fas fa-comments"></i> KotoGram</h2>
                <div class="auth-tabs">
                    <div class="auth-tab active" id="loginTab">Вход</div>
                    <div class="auth-tab" id="registerTab">Регистрация</div>
                </div>
                
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="ваш@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Пароль</label>
                        <input type="password" id="loginPassword" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="btn btn-block">
                        <i class="fas fa-sign-in-alt"></i> Войти
                    </button>
                </form>
                
                <form id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label for="registerUsername">Имя пользователя (уникальное)</label>
                        <input type="text" id="registerUsername" placeholder="Придумайте уникальное имя" required>
                        <div class="username-check" style="margin-top: 5px; font-size: 12px;"></div>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" placeholder="ваш@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Пароль (минимум 6 символов)</label>
                        <input type="password" id="registerPassword" placeholder="••••••••" minlength="6" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Подтвердите пароль</label>
                        <input type="password" id="confirmPassword" placeholder="••••••••" minlength="6" required>
                    </div>
                    <button type="submit" class="btn btn-block">
                        <i class="fas fa-user-plus"></i> Зарегистрироваться
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Основной интерфейс -->
        <div class="chat-interface" id="chatInterface" style="display: none; width: 100%;">
            <div class="sidebar">
                <div class="header">
                    <h1><i class="fas fa-comment-dots"></i> KotoGram</h1>
                </div>
                
                <div class="current-user" id="currentUser">
                    <div class="user-avatar" id="currentUserAvatar">
                        <span id="currentUserInitial">U</span>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="currentUserName">Пользователь</div>
                        <div class="user-status">
                            <span class="online-dot"></span>
                            <span id="currentUserStatus">Online</span>
                        </div>
                    </div>
                    <button class="btn btn-profile btn-sm" id="profileBtn">
                        <i class="fas fa-user-edit"></i>
                    </button>
                    <button class="btn btn-logout btn-sm" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
                
                <div class="users-list">
                    <div class="users-title">
                        <span>Все пользователи</span>
                        <span class="users-count" id="usersCount">0</span>
                    </div>
                    <div id="usersListContainer">
                        <!-- Список пользователей будет здесь -->
                    </div>
                </div>
            </div>
            
            <div class="chat-main">
                <div class="chat-header" id="chatHeader">
                    <div class="chat-header-info">
                        <div>
                            <h2 id="chatWithName">Общий чат</h2>
                            <div class="chat-type" id="chatType">Групповой чат</div>
                        </div>
                    </div>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <div class="welcome-message" id="welcomeMessage">
                        <i class="fas fa-comments fa-3x" style="margin-bottom: 20px; color: var(--primary);"></i>
                        <h3>Добро пожаловать в KotoGram!</h3>
                        <p style="margin-top: 10px;">Выберите пользователя слева для начала общения</p>
                    </div>
                </div>
                
                <div class="input-container" id="inputContainer" style="display: none;">
                    <div class="input-tools">
                        <button class="tool-btn" id="emojiBtn" title="Эмодзи">
                            <i class="fas fa-smile"></i>
                        </button>
                        <button class="tool-btn" id="imageBtn" title="Отправить изображение">
                            <i class="fas fa-image"></i>
                        </button>
                    </div>
                    <div class="message-input-wrapper">
                        <textarea class="message-input" id="messageInput" placeholder="Напишите сообщение..." maxlength="2000"></textarea>
                        <button class="send-btn" id="sendBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="emoji-picker-container" id="emojiPicker"></div>
                </div>
            </div>
        </div>
        
        <!-- Загрузка изображений -->
        <div class="file-upload-overlay" id="fileUploadOverlay">
            <div class="file-upload-box">
                <h3>Отправить изображение</h3>
                <div class="file-preview" id="filePreview">
                    <i class="fas fa-image fa-3x" style="color: var(--gray);"></i>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                <div class="upload-buttons">
                    <button class="btn" id="selectFileBtn">
                        <i class="fas fa-folder-open"></i> Выбрать файл
                    </button>
                    <button class="btn" id="sendFileBtn" disabled>
                        <i class="fas fa-paper-plane"></i> Отправить
                    </button>
                    <button class="btn" id="cancelFileBtn">
                        <i class="fas fa-times"></i> Отмена
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Полноэкранное изображение -->
        <div class="fullscreen-image" id="fullscreenImage">
            <button class="close-fullscreen" id="closeFullscreen">
                <i class="fas fa-times"></i>
            </button>
            <img id="fullscreenImg" src="" alt="">
        </div>
        
        <!-- Модальное окно профиля -->
        <div class="modal" id="profileModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-user-edit"></i> Настройки профиля</h3>
                    <button class="modal-close" id="closeProfileModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="avatar-upload">
                        <div class="avatar-preview" id="avatarPreview">
                            <span id="avatarInitial">U</span>
                        </div>
                        <button class="btn upload-btn">
                            <i class="fas fa-camera"></i> Загрузить аватар
                            <input type="file" id="avatarUpload" accept="image/*">
                        </button>
                        <div class="avatar-colors" id="avatarColors">
                            <!-- Цвета будут добавлены через JS -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="profileUsername">Имя пользователя</label>
                        <input type="text" id="profileUsername" placeholder="Уникальное имя">
                        <div class="username-check" style="margin-top: 5px; font-size: 12px;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="profileStatus">Статус</label>
                        <textarea id="profileStatus" placeholder="Расскажите о себе..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Статус онлайн</label>
                        <div class="status-options">
                            <div class="status-option selected" data-status="online">Online</div>
                            <div class="status-option" data-status="away">Отошел</div>
                            <div class="status-option" data-status="dnd">Не беспокоить</div>
                            <div class="status-option" data-status="offline">Offline</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="profileEmail">Email (для уведомлений)</label>
                        <input type="email" id="profileEmail" disabled>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" id="cancelProfileBtn">Отмена</button>
                    <button class="btn" id="saveProfileBtn">
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Импорт Firebase модулей
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            orderBy, 
            onSnapshot,
            serverTimestamp,
            Timestamp,
            where,
            getDocs,
            doc,
            setDoc,
            getDoc,
            updateDoc,
            arrayUnion
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCcaRsyPSMvuNrHPEqEwg_kajoLhlvsv2M",
            authDomain: "kotogram-c360f.firebaseapp.com",
            projectId: "kotogram-c360f",
            storageBucket: "kotogram-c360f.firebasestorage.app",
            messagingSenderId: "239052405176",
            appId: "1:239052405176:web:bcf298e9bb2a946906774d",
            measurementId: "G-GQN558YHP6"
        };

        // Инициализация Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM элементы
        const authContainer = document.getElementById('authContainer');
        const chatInterface = document.getElementById('chatInterface');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const logoutBtn = document.getElementById('logoutBtn');
        const profileBtn = document.getElementById('profileBtn');
        const currentUserAvatar = document.getElementById('currentUserAvatar');
        const currentUserName = document.getElementById('currentUserName');
        const currentUserInitial = document.getElementById('currentUserInitial');
        const currentUserStatus = document.getElementById('currentUserStatus');
        const usersListContainer = document.getElementById('usersListContainer');
        const usersCount = document.getElementById('usersCount');
        const messagesContainer = document.getElementById('messagesContainer');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const chatHeader = document.getElementById('chatHeader');
        const chatWithName = document.getElementById('chatWithName');
        const chatType = document.getElementById('chatType');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const inputContainer = document.getElementById('inputContainer');
        
        // Элементы для эмодзи и изображений
        const emojiBtn = document.getElementById('emojiBtn');
        const imageBtn = document.getElementById('imageBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const fileUploadOverlay = document.getElementById('fileUploadOverlay');
        const filePreview = document.getElementById('filePreview');
        const fileInput = document.getElementById('fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const sendFileBtn = document.getElementById('sendFileBtn');
        const cancelFileBtn = document.getElementById('cancelFileBtn');
        const fullscreenImage = document.getElementById('fullscreenImage');
        const fullscreenImg = document.getElementById('fullscreenImg');
        const closeFullscreen = document.getElementById('closeFullscreen');
        
        // Модальное окно профиля
        const profileModal = document.getElementById('profileModal');
        const closeProfileModal = document.getElementById('closeProfileModal');
        const cancelProfileBtn = document.getElementById('cancelProfileBtn');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const avatarPreview = document.getElementById('avatarPreview');
        const avatarInitial = document.getElementById('avatarInitial');
        const avatarUpload = document.getElementById('avatarUpload');
        const avatarColors = document.getElementById('avatarColors');
        const profileUsername = document.getElementById('profileUsername');
        const profileStatus = document.getElementById('profileStatus');
        const profileEmail = document.getElementById('profileEmail');

        // Переменные состояния
        let currentUser = null;
        let currentChat = 'general'; // 'general' или userId пользователя
        let currentChatUser = null;
        let allUsers = [];
        let selectedAvatarColor = '#6366f1';
        let selectedStatus = 'online';
        let unreadMessages = {};
        let messageListener = null;
        let selectedFile = null;

        // Цвета для аватарок
        const avatarColorsList = [
            '#6366f1', '#10b981', '#f59e0b', '#ef4444', 
            '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16'
        ];

        // Генерация цветов аватарок
        avatarColorsList.forEach(color => {
            const colorDiv = document.createElement('div');
            colorDiv.className = 'color-option';
            colorDiv.style.background = color;
            colorDiv.dataset.color = color;
            colorDiv.addEventListener('click', () => {
                document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
                colorDiv.classList.add('selected');
                selectedAvatarColor = color;
                avatarPreview.style.background = color;
                avatarInitial.style.color = 'white';
            });
            avatarColors.appendChild(colorDiv);
        });

        // Инициализация первого цвета как выбранного
        document.querySelector('.color-option').classList.add('selected');

        // Статусы
        document.querySelectorAll('.status-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.status-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedStatus = option.dataset.status;
            });
        });

        // Инициализация эмодзи-пикера
        const picker = document.createElement('emoji-picker');
        picker.addEventListener('emoji-click', event => {
            const emoji = event.detail.unicode;
            messageInput.value += emoji;
            messageInput.focus();
            emojiPicker.style.display = 'none';
        });
        emojiPicker.appendChild(picker);

        // Управление эмодзи-пикером
        emojiBtn.addEventListener('click', () => {
            emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
            if (emojiPicker.style.display === 'block') {
                messageInput.focus();
            }
        });

        // Закрытие эмодзи-пикера при клике вне его
        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                emojiPicker.style.display = 'none';
            }
        });

        // Управление загрузкой изображений
        imageBtn.addEventListener('click', () => {
            fileUploadOverlay.style.display = 'flex';
        });

        selectFileBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Пожалуйста, выберите изображение');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('Размер изображения не должен превышать 5MB');
                return;
            }
            
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                filePreview.innerHTML = `<img src="${e.target.result}" alt="Превью">`;
                sendFileBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        });

        sendFileBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            
            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    await sendImageMessage(e.target.result);
                    fileUploadOverlay.style.display = 'none';
                    filePreview.innerHTML = '<i class="fas fa-image fa-3x" style="color: var(--gray);"></i>';
                    selectedFile = null;
                    sendFileBtn.disabled = true;
                    fileInput.value = '';
                };
                reader.readAsDataURL(selectedFile);
            } catch (error) {
                console.error('Ошибка отправки изображения:', error);
                alert('Не удалось отправить изображение');
            }
        });

        cancelFileBtn.addEventListener('click', () => {
            fileUploadOverlay.style.display = 'none';
            filePreview.innerHTML = '<i class="fas fa-image fa-3x" style="color: var(--gray);"></i>';
            selectedFile = null;
            sendFileBtn.disabled = true;
            fileInput.value = '';
        });

        // Полноэкранное изображение
        function openFullscreenImage(src) {
            fullscreenImg.src = src;
            fullscreenImage.style.display = 'flex';
        }

        closeFullscreen.addEventListener('click', () => {
            fullscreenImage.style.display = 'none';
        });

        fullscreenImage.addEventListener('click', (e) => {
            if (e.target === fullscreenImage) {
                fullscreenImage.style.display = 'none';
            }
        });

        // Переключение между вкладками входа/регистрации
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        });

        registerTab.addEventListener('click', () => {
            registerTab.classList.add('active');
            loginTab.classList.remove('active');
            registerForm.style.display = 'block';
            loginForm.style.display = 'none';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        });

        // Проверка уникальности имени пользователя
        let usernameCheckTimeout;
        document.getElementById('registerUsername').addEventListener('input', async (e) => {
            clearTimeout(usernameCheckTimeout);
            const username = e.target.value.trim();
            const checkDiv = e.target.nextElementSibling;
            
            if (username.length < 3) {
                checkDiv.textContent = 'Имя должно быть не менее 3 символов';
                checkDiv.style.color = '#ef4444';
                return;
            }
            
            if (!/^[a-zA-Zа-яА-Я0-9_]+$/.test(username)) {
                checkDiv.textContent = 'Только буквы, цифры и подчеркивание';
                checkDiv.style.color = '#ef4444';
                return;
            }
            
            usernameCheckTimeout = setTimeout(async () => {
                const isUnique = await checkUsernameUnique(username);
                if (isUnique) {
                    checkDiv.textContent = '✓ Имя доступно';
                    checkDiv.style.color = '#10b981';
                } else {
                    checkDiv.textContent = '✗ Имя уже занято';
                    checkDiv.style.color = '#ef4444';
                }
            }, 500);
        });

        profileUsername.addEventListener('input', async (e) => {
            clearTimeout(usernameCheckTimeout);
            const username = e.target.value.trim();
            const checkDiv = e.target.nextElementSibling;
            
            if (username === currentUser?.displayName) {
                checkDiv.textContent = '✓ Это ваше текущее имя';
                checkDiv.style.color = '#10b981';
                return;
            }
            
            if (username.length < 3) {
                checkDiv.textContent = 'Имя должно быть не менее 3 символов';
                checkDiv.style.color = '#ef4444';
                return;
            }
            
            if (!/^[a-zA-Zа-яА-Я0-9_]+$/.test(username)) {
                checkDiv.textContent = 'Только буквы, цифры и подчеркивание';
                checkDiv.style.color = '#ef4444';
                return;
            }
            
            usernameCheckTimeout = setTimeout(async () => {
                const isUnique = await checkUsernameUnique(username);
                if (isUnique) {
                    checkDiv.textContent = '✓ Имя доступно';
                    checkDiv.style.color = '#10b981';
                } else {
                    checkDiv.textContent = '✗ Имя уже занято';
                    checkDiv.style.color = '#ef4444';
                }
            }, 500);
        });

        async function checkUsernameUnique(username) {
            if (!username) return false;
            
            try {
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('username', '==', username.toLowerCase()));
                const querySnapshot = await getDocs(q);
                return querySnapshot.empty;
            } catch (error) {
                console.error('Ошибка проверки имени:', error);
                return false;
            }
        }

        // Регистрация нового пользователя
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Валидация
            if (!/^[a-zA-Zа-яА-Я0-9_]+$/.test(username)) {
                showError('Имя может содержать только буквы, цифры и подчеркивание');
                return;
            }
            
            if (username.length < 3) {
                showError('Имя должно быть не менее 3 символов');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('Пароли не совпадают');
                return;
            }
            
            if (password.length < 6) {
                showError('Пароль должен содержать минимум 6 символов');
                return;
            }
            
            // Проверка уникальности имени
            const isUnique = await checkUsernameUnique(username);
            if (!isUnique) {
                showError('Это имя пользователя уже занято');
                return;
            }
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Создаем профиль пользователя в Firestore
                await setDoc(doc(db, 'users', user.uid), {
                    uid: user.uid,
                    username: username.toLowerCase(),
                    displayName: username,
                    email: email,
                    status: 'Привет! Я новый пользователь KotoGram',
                    avatarColor: avatarColorsList[Math.floor(Math.random() * avatarColorsList.length)],
                    online: true,
                    lastSeen: serverTimestamp(),
                    createdAt: serverTimestamp(),
                    onlineStatus: 'online'
                });
                
                // Обновляем displayName в Auth
                await updateProfile(user, {
                    displayName: username
                });
                
                showSuccess('Регистрация успешна!');
                loginTab.click();
                registerForm.reset();
                
            } catch (error) {
                console.error('Ошибка регистрации:', error);
                showError(getAuthErrorMessage(error.code));
            }
        });

        // Вход пользователя
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginForm.reset();
            } catch (error) {
                console.error('Ошибка входа:', error);
                showError(getAuthErrorMessage(error.code));
            }
        });

        // Выход из системы
        logoutBtn.addEventListener('click', async () => {
            try {
                if (currentUser) {
                    await updateDoc(doc(db, 'users', currentUser.uid), {
                        online: false,
                        lastSeen: serverTimestamp()
                    });
                }
                await signOut(auth);
            } catch (error) {
                console.error('Ошибка выхода:', error);
            }
        });

        // Открытие/закрытие модального окна профиля
        profileBtn.addEventListener('click', () => {
            openProfileModal();
        });

        closeProfileModal.addEventListener('click', () => {
            profileModal.style.display = 'none';
        });

        cancelProfileBtn.addEventListener('click', () => {
            profileModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === profileModal) {
                profileModal.style.display = 'none';
            }
        });

        function openProfileModal() {
            if (!currentUser) return;
            
            profileModal.style.display = 'flex';
            profileUsername.value = currentUser.displayName || '';
            profileStatus.value = currentUser.userData?.status || '';
            profileEmail.value = currentUser.email || '';
            
            // Устанавливаем выбранный цвет
            const userColor = currentUser.userData?.avatarColor || selectedAvatarColor;
            selectedAvatarColor = userColor;
            document.querySelectorAll('.color-option').forEach(c => {
                c.classList.remove('selected');
                if (c.dataset.color === userColor) {
                    c.classList.add('selected');
                }
            });
            
            avatarPreview.style.background = userColor;
            avatarInitial.textContent = (currentUser.displayName || 'U').charAt(0).toUpperCase();
            
            // Устанавливаем аватарку, если есть
            if (currentUser.userData?.avatarBase64) {
                avatarPreview.innerHTML = `<img src="${currentUser.userData.avatarBase64}" alt="Аватар">`;
            } else {
                avatarPreview.innerHTML = `<span id="avatarInitial">${(currentUser.displayName || 'U').charAt(0).toUpperCase()}</span>`;
            }
            
            // Устанавливаем статус
            selectedStatus = currentUser.userData?.onlineStatus || 'online';
            document.querySelectorAll('.status-option').forEach(o => {
                o.classList.remove('selected');
                if (o.dataset.status === selectedStatus) {
                    o.classList.add('selected');
                }
            });
        }

        // Загрузка аватарки (base64)
        avatarUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showError('Пожалуйста, выберите изображение', true);
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) { // 2MB максимум
                showError('Размер изображения не должен превышать 2MB', true);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                // Показываем превью
                avatarPreview.innerHTML = `<img src="${e.target.result}" alt="Аватар">`;
                
                // Сохраняем base64 для отправки
                avatarPreview.dataset.base64 = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Сохранение профиля
        saveProfileBtn.addEventListener('click', async () => {
            if (!currentUser) return;
            
            const username = profileUsername.value.trim();
            const status = profileStatus.value.trim();
            const avatarBase64 = avatarPreview.dataset.base64;
            
            // Валидация имени пользователя
            if (!/^[a-zA-Zа-яА-Я0-9_]+$/.test(username)) {
                showError('Имя может содержать только буквы, цифры и подчеркивание', true);
                return;
            }
            
            if (username.length < 3) {
                showError('Имя должно быть не менее 3 символов', true);
                return;
            }
            
            // Проверка уникальности имени (если изменилось)
            if (username.toLowerCase() !== currentUser.displayName?.toLowerCase()) {
                const isUnique = await checkUsernameUnique(username);
                if (!isUnique) {
                    showError('Это имя пользователя уже занято', true);
                    return;
                }
            }
            
            try {
                // Подготавливаем данные для обновления
                const updateData = {
                    displayName: username,
                    username: username.toLowerCase(),
                    status: status || 'Привет! Я пользователь KotoGram',
                    avatarColor: selectedAvatarColor,
                    onlineStatus: selectedStatus,
                    updatedAt: serverTimestamp()
                };
                
                // Добавляем base64 аватарки, если есть
                if (avatarBase64) {
                    updateData.avatarBase64 = avatarBase64;
                }
                
                // Обновляем профиль в Firestore
                await updateDoc(doc(db, 'users', currentUser.uid), updateData);
                
                // Обновляем displayName в Auth
                await updateProfile(currentUser, {
                    displayName: username
                });
                
                // Обновляем текущего пользователя
                currentUser.displayName = username;
                if (avatarBase64) {
                    currentUser.userData.avatarBase64 = avatarBase64;
                }
                currentUser.userData.avatarColor = selectedAvatarColor;
                currentUser.userData.status = status;
                currentUser.userData.onlineStatus = selectedStatus;
                
                updateCurrentUserUI();
                
                showSuccess('Профиль успешно обновлен!', true);
                setTimeout(() => {
                    profileModal.style.display = 'none';
                }, 1500);
                
            } catch (error) {
                console.error('Ошибка обновления профиля:', error);
                showError('Не удалось обновить профиль', true);
            }
        });

        // Отправка сообщения
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Авторазмер textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText || !currentUser) return;
            
            try {
                // Проверяем, это только эмодзи или обычный текст
                const isOnlyEmoji = messageText.length <= 3 && /^\p{Emoji}+$/u.test(messageText);
                const messageType = isOnlyEmoji ? 'emoji' : 'text';
                
                const messageData = {
                    type: messageType,
                    text: messageText,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email,
                    senderAvatarColor: currentUser.userData?.avatarColor || '#6366f1',
                    timestamp: serverTimestamp(),
                    readBy: [currentUser.uid]
                };
                
                if (currentUser.userData?.avatarBase64) {
                    messageData.senderAvatar = currentUser.userData.avatarBase64;
                }
                
                if (currentChat === 'general') {
                    messageData.chatType = 'general';
                    await addDoc(collection(db, 'messages'), messageData);
                } else {
                    const chatId = getChatId(currentUser.uid, currentChat);
                    messageData.receiverId = currentChat;
                    messageData.chatId = chatId;
                    await addDoc(collection(db, 'privateMessages'), messageData);
                    
                    // Сбрасываем счетчик непрочитанных для этого чата
                    unreadMessages[currentChat] = 0;
                    updateUnreadBadges();
                }
                
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
            } catch (error) {
                console.error('Ошибка отправки сообщения:', error);
                showError('Не удалось отправить сообщение');
            }
        }

        async function sendImageMessage(imageBase64) {
            if (!currentUser) return;
            
            try {
                const messageData = {
                    type: 'image',
                    image: imageBase64,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email,
                    senderAvatarColor: currentUser.userData?.avatarColor || '#6366f1',
                    timestamp: serverTimestamp(),
                    readBy: [currentUser.uid]
                };
                
                if (currentUser.userData?.avatarBase64) {
                    messageData.senderAvatar = currentUser.userData.avatarBase64;
                }
                
                if (currentChat === 'general') {
                    messageData.chatType = 'general';
                    await addDoc(collection(db, 'messages'), messageData);
                } else {
                    const chatId = getChatId(currentUser.uid, currentChat);
                    messageData.receiverId = currentChat;
                    messageData.chatId = chatId;
                    await addDoc(collection(db, 'privateMessages'), messageData);
                    
                    unreadMessages[currentChat] = 0;
                    updateUnreadBadges();
                }
                
            } catch (error) {
                console.error('Ошибка отправки изображения:', error);
                throw error;
            }
        }

        // Генерация chatId для приватных сообщений
        function getChatId(userId1, userId2) {
            return [userId1, userId2].sort().join('_');
        }

        // Загрузка и отображение сообщений
        function setupMessagesListener(chatId, type = 'general') {
            // Отключаем предыдущий слушатель, если он есть
            if (messageListener) {
                messageListener();
                messageListener = null;
            }
            
            // Очищаем контейнер
            messagesContainer.innerHTML = '';
            
            let messagesQuery;
            
            if (type === 'general') {
                // Общий чат - все сообщения
                messagesQuery = query(
                    collection(db, 'messages'), 
                    orderBy('timestamp', 'asc')
                );
            } else {
                // Личный чат - только сообщения между двумя пользователями
                const chatIdStr = getChatId(currentUser.uid, chatId);
                messagesQuery = query(
                    collection(db, 'privateMessages'),
                    where('chatId', '==', chatIdStr),
                    orderBy('timestamp', 'asc')
                );
                
                // Помечаем сообщения как прочитанные
                markMessagesAsRead(chatId);
            }
            
            // Устанавливаем новый слушатель
            messageListener = onSnapshot(messagesQuery, (snapshot) => {
                messagesContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    welcomeMessage.style.display = 'flex';
                    return;
                }
                
                welcomeMessage.style.display = 'none';
                
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    displayMessage(message);
                });
                
                // Прокрутка к последнему сообщению
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
                
            }, (error) => {
                console.error('Ошибка слушателя сообщений:', error);
            });
        }

        async function markMessagesAsRead(userId) {
            if (!currentUser) return;
            
            const chatId = getChatId(currentUser.uid, userId);
            const messagesQuery = query(
                collection(db, 'privateMessages'),
                where('chatId', '==', chatId),
                where('receiverId', '==', currentUser.uid)
            );
            
            try {
                const querySnapshot = await getDocs(messagesQuery);
                const updatePromises = [];
                
                querySnapshot.forEach((docSnap) => {
                    const message = docSnap.data();
                    // Если сообщение еще не прочитано текущим пользователем
                    if (!message.readBy || !message.readBy.includes(currentUser.uid)) {
                        updatePromises.push(
                            updateDoc(doc(db, 'privateMessages', docSnap.id), {
                                readBy: arrayUnion(currentUser.uid)
                            })
                        );
                    }
                });
                
                // Выполняем все обновления
                if (updatePromises.length > 0) {
                    await Promise.all(updatePromises);
                }
                
            } catch (error) {
                console.error('Ошибка пометки сообщений как прочитанных:', error);
            }
        }

        function displayMessage(message) {
            // Определяем отправителя сообщения
            const isSent = currentUser && message.senderId === currentUser.uid;
            const messageClass = isSent ? 'sent' : 'received';
            
            // Форматирование времени
            let timeString = 'только что';
            if (message.timestamp) {
                const timestamp = message.timestamp instanceof Timestamp 
                    ? message.timestamp.toDate() 
                    : new Date(message.timestamp);
                const now = new Date();
                const diffMs = now - timestamp;
                const diffMins = Math.floor(diffMs / 60000);
                
                if (diffMins < 1) {
                    timeString = 'только что';
                } else if (diffMins < 60) {
                    timeString = `${diffMins} мин назад`;
                } else {
                    timeString = timestamp.toLocaleTimeString('ru-RU', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                }
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${messageClass}`;
            
            let contentHTML = '';
            
            if (message.type === 'emoji') {
                contentHTML = `
                    <div class="emoji-large">${message.text}</div>
                `;
            } else if (message.type === 'image' && message.image) {
                contentHTML = `
                    <img src="${message.image}" alt="Изображение" class="message-image" 
                         onclick="window.openFullscreenImage('${message.image}')">
                `;
            } else {
                contentHTML = `<div class="message-text">${escapeHtml(message.text)}</div>`;
            }
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${escapeHtml(message.senderName)}</span>
                    <span class="message-time">${timeString}</span>
                </div>
                ${contentHTML}
                ${isSent && message.readBy && message.readBy.length > 1 ? '<div class="message-status">✓ Прочитано</div>' : ''}
            `;
            
            messagesContainer.appendChild(messageElement);
        }

        // Загрузка списка пользователей
        function setupUsersListener() {
            const usersQuery = query(collection(db, 'users'), orderBy('displayName'));
            
            onSnapshot(usersQuery, (snapshot) => {
                usersListContainer.innerHTML = '';
                allUsers = [];
                
                snapshot.forEach((doc) => {
                    const user = doc.data();
                    allUsers.push(user);
                    
                    // Не показываем текущего пользователя в списке
                    if (currentUser && user.uid === currentUser.uid) return;
                    
                    const userElement = document.createElement('div');
                    userElement.className = 'user-item';
                    userElement.dataset.userId = user.uid;
                    
                    // Определяем цвет аватарки
                    const avatarColor = user.avatarColor || avatarColorsList[0];
                    const userInitial = (user.displayName || user.email || 'U').charAt(0).toUpperCase();
                    
                    userElement.innerHTML = `
                        <div class="user-item-avatar" style="background: ${avatarColor};">
                            ${user.avatarBase64 ? `<img src="${user.avatarBase64}" alt="${user.displayName}" class="avatar-img">` : userInitial}
                        </div>
                        <div class="user-item-info">
                            <div class="user-item-name">${escapeHtml(user.displayName || user.email)}</div>
                            <div class="user-item-status">${escapeHtml(user.status || 'Нет статуса')}</div>
                        </div>
                        ${user.online ? '<span class="online-dot"></span>' : ''}
                        ${unreadMessages[user.uid] > 0 ? `<span class="unread-badge">${unreadMessages[user.uid]}</span>` : ''}
                    `;
                    
                    userElement.addEventListener('click', () => {
                        // Убираем активный класс у всех пользователей
                        document.querySelectorAll('.user-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // Добавляем активный класс выбранному пользователю
                        userElement.classList.add('active');
                        
                        // Открываем чат с пользователем
                        openPrivateChat(user);
                    });
                    
                    usersListContainer.appendChild(userElement);
                });
                
                usersCount.textContent = allUsers.length;
                
                // Добавляем элемент общего чата в начало
                const generalChatElement = document.createElement('div');
                generalChatElement.className = 'user-item active';
                generalChatElement.dataset.chatType = 'general';
                generalChatElement.innerHTML = `
                    <div class="user-item-avatar" style="background: #6366f1;">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="user-item-info">
                        <div class="user-item-name">Общий чат</div>
                        <div class="user-item-status">Общайтесь со всеми пользователями</div>
                    </div>
                `;
                
                generalChatElement.addEventListener('click', () => {
                    document.querySelectorAll('.user-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    generalChatElement.classList.add('active');
                    openGeneralChat();
                });
                
                usersListContainer.insertBefore(generalChatElement, usersListContainer.firstChild);
            });
        }

        // Слушатель для непрочитанных сообщений
        function setupUnreadMessagesListener() {
            if (!currentUser) return;
            
            const unreadQuery = query(
                collection(db, 'privateMessages'),
                where('receiverId', '==', currentUser.uid)
            );
            
            onSnapshot(unreadQuery, (snapshot) => {
                // Сбрасываем счетчики
                unreadMessages = {};
                
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    const senderId = message.senderId;
                    
                    if (senderId === currentUser.uid) return; // Пропускаем свои сообщения
                    
                    if (!unreadMessages[senderId]) {
                        unreadMessages[senderId] = 0;
                    }
                    
                    // Если сообщение не прочитано текущим пользователем
                    if (!message.readBy || !message.readBy.includes(currentUser.uid)) {
                        unreadMessages[senderId]++;
                    }
                });
                
                updateUnreadBadges();
            });
        }

        function updateUnreadBadges() {
            document.querySelectorAll('.user-item').forEach(item => {
                const userId = item.dataset.userId;
                if (userId && unreadMessages[userId] > 0) {
                    let badge = item.querySelector('.unread-badge');
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'unread-badge';
                        item.appendChild(badge);
                    }
                    badge.textContent = unreadMessages[userId];
                } else {
                    const badge = item.querySelector('.unread-badge');
                    if (badge) {
                        badge.remove();
                    }
                }
            });
        }

        function openGeneralChat() {
            currentChat = 'general';
            currentChatUser = null;
            chatWithName.textContent = 'Общий чат';
            chatType.textContent = 'Групповой чат';
            inputContainer.style.display = 'flex';
            setupMessagesListener('general', 'general');
        }

        function openPrivateChat(user) {
            currentChat = user.uid;
            currentChatUser = user;
            chatWithName.textContent = user.displayName || user.email;
            chatType.textContent = 'Личные сообщения';
            inputContainer.style.display = 'flex';
            setupMessagesListener(user.uid, 'private');
            
            // Сбрасываем счетчик непрочитанных
            unreadMessages[user.uid] = 0;
            updateUnreadBadges();
        }

        // Обновление UI текущего пользователя
        function updateCurrentUserUI() {
            if (!currentUser) return;
            
            const userData = currentUser.userData || {};
            const displayName = currentUser.displayName || currentUser.email || 'Пользователь';
            const avatarColor = userData.avatarColor || avatarColorsList[0];
            const userInitial = displayName.charAt(0).toUpperCase();
            const status = userData.status || 'Привет! Я пользователь KotoGram';
            const onlineStatus = userData.onlineStatus || 'online';
            
            currentUserName.textContent = displayName;
            currentUserInitial.textContent = userInitial;
            currentUserAvatar.style.background = avatarColor;
            currentUserStatus.textContent = onlineStatus === 'online' ? 'Online' : 
                                           onlineStatus === 'away' ? 'Отошел' :
                                           onlineStatus === 'dnd' ? 'Не беспокоить' : 'Offline';
            
            // Устанавливаем аватарку, если есть base64
            if (userData.avatarBase64) {
                currentUserAvatar.innerHTML = `<img src="${userData.avatarBase64}" alt="${displayName}" class="avatar-img">`;
            } else {
                currentUserAvatar.innerHTML = `<span>${userInitial}</span>`;
            }
        }

        // Следим за состоянием аутентификации
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Пользователь вошел
                currentUser = user;
                
                try {
                    // Загружаем данные пользователя из Firestore
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        currentUser.userData = userDoc.data();
                        
                        // Обновляем статус онлайн
                        await updateDoc(doc(db, 'users', user.uid), {
                            online: true,
                            lastSeen: serverTimestamp()
                        });
                    } else {
                        // Создаем запись пользователя, если ее нет
                        await setDoc(doc(db, 'users', user.uid), {
                            uid: user.uid,
                            username: (user.email || '').split('@')[0] || 'user',
                            displayName: user.displayName || user.email,
                            email: user.email,
                            status: 'Привет! Я новый пользователь KotoGram',
                            avatarColor: avatarColorsList[Math.floor(Math.random() * avatarColorsList.length)],
                            online: true,
                            lastSeen: serverTimestamp(),
                            createdAt: serverTimestamp(),
                            onlineStatus: 'online'
                        });
                        
                        currentUser.userData = await getDoc(doc(db, 'users', user.uid)).then(doc => doc.data());
                    }
                    
                    // Обновляем UI
                    updateCurrentUserUI();
                    
                    // Показываем интерфейс чата
                    authContainer.style.display = 'none';
                    chatInterface.style.display = 'flex';
                    
                    // Настраиваем слушатели
                    setupUsersListener();
                    setupUnreadMessagesListener();
                    openGeneralChat();
                    
                } catch (error) {
                    console.error('Ошибка загрузки данных пользователя:', error);
                }
            } else {
                // Пользователь вышел
                currentUser = null;
                authContainer.style.display = 'flex';
                chatInterface.style.display = 'none';
                messagesContainer.innerHTML = '';
                usersListContainer.innerHTML = '';
                
                // Отключаем слушатели
                if (messageListener) {
                    messageListener();
                    messageListener = null;
                }
                
                // Сбрасываем формы
                loginForm.reset();
                registerForm.reset();
            }
        });

        // Вспомогательные функции
        function showError(text, inModal = false) {
            if (inModal) {
                alert(text);
            } else {
                errorMessage.textContent = text;
                errorMessage.style.display = 'block';
                successMessage.style.display = 'none';
                
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }
        }

        function showSuccess(text, inModal = false) {
            if (inModal) {
                alert(text);
            } else {
                successMessage.textContent = text;
                successMessage.style.display = 'block';
                errorMessage.style.display = 'none';
                
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 3000);
            }
        }

        function getAuthErrorMessage(errorCode) {
            const messages = {
                'auth/email-already-in-use': 'Этот email уже используется',
                'auth/invalid-email': 'Некорректный email адрес',
                'auth/operation-not-allowed': 'Операция не разрешена',
                'auth/weak-password': 'Пароль слишком простой',
                'auth/user-disabled': 'Аккаунт отключен',
                'auth/user-not-found': 'Пользователь не найден',
                'auth/wrong-password': 'Неверный пароль',
                'auth/too-many-requests': 'Слишком много попыток. Попробуйте позже'
            };
            
            return messages[errorCode] || 'Произошла ошибка. Попробуйте снова';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Экспортируем функцию для полноэкранного просмотра
        window.openFullscreenImage = openFullscreenImage;
    </script>
</body>
</html>
